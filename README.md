# 图文处理工具

## 项目概述
这是一个基于 React 的图文处理工具，用于处理封面图片、背景图片和文本内容，生成带有特定格式的图文素材包。该工具支持批量处理，可以同时处理多组图文内容，并支持JPG/PNG格式的图片输出。

## 主要功能

### 1. 文件上传与处理
#### 1.1 封面图片（可选）
- 支持多个封面图片上传
- 支持跳过封面图片，使用纯色背景
- 自动调整尺寸为1242x1660像素
- 支持JPG/PNG格式

#### 1.2 背景素材图片（必选）
- 支持多个背景图片上传
- 自动调整尺寸为1242x1660像素
- 自动调整透明度为0.35
- 添加黑色背景层
- 支持严谨模式、宽松模式和谨慎模式的素材使用规则

#### 1.3 Excel文件处理（必选）
- 支持.xlsx、.xls、.csv格式
- 自动保存上传的Excel文件
- 支持刷新页面后保持数据
- 文本内容自动随机打乱并分页

#### 1.4 知识Excel文件处理（知识拼接模式可选）
- 支持.xlsx、.xls、.csv格式
- 需包含A列(标题)和B列(内容)
- 每个标题和内容对应生成一张精美的知识图片
- 每个标题内容对只使用一次，不重复使用

### 2. 处理模式
#### 2.1 严谨模式
- 每个背景图片仅使用一次
- 当背景图片不足时停止处理并提示
- 适合需要严格控制素材使用的场景

#### 2.2 宽松模式
- 背景图片可重复使用
- 适合素材数量有限的场景

#### 2.3 谨慎模式
- 基于严谨模式的升级版
- 每个背景图片仅使用一次
- 只有第一页显示内页标题，其他页面不显示标题
- 非第一页有更多可用空间，可容纳更多内容
- 更适合长篇内容的展示

#### 2.4 知识拼接模式
- 可与其他模式同时使用（宽松/严谨/谨慎）
- 从知识Excel文件读取标题和内容
- 每条知识生成一张精美的卡片式知识图片
- 支持设置每个文件夹生成的知识图片数量(0-50)
- 图片设计包含圆角卡片、阴影效果和装饰元素
- 支持文本自动换行和保留原始换行格式

### 3. 输出选项
#### 3.1 图片格式选择
- 支持JPG格式（默认）
- 支持PNG格式
- 可随时切换输出格式

#### 3.2 内页数量限制
- 支持设置每个文件夹内页数量限制（0-100）
- 0表示不限制，使用默认生成逻辑
- 数量限制时优先保留首尾页
- 从倒数第二页往前删除多余页面

#### 3.3 文件组织
- 使用4位数字命名文件夹（0001-9999）
- 通过IndexedDB确保编号不重复
- 每个文件夹包含：
  - 内页图片（自动编号）
  - 封面图片（如果有）
  - 知识图片（如果启用知识拼接模式）
  - 所有图片按顺序编号

### 4. 用户界面功能
- 实时进度条显示处理进度
- 文件上传状态提示
- 处理完成提示
- 错误信息显示
- 自定义内页标题文本
- 自定义背景颜色
- 拖拽上传文件
- 模式切换与参数设置

## 技术实现

### 1. 核心文件说明
#### 1.1 src/App.js
- 主应用组件
- 状态管理
- 用户界面渲染
- 文件上传处理
- 进度显示逻辑
- 不同模式参数控制

#### 1.2 src/services/imageProcessor.js
- 图片处理核心逻辑
- 尺寸调整
- 透明度处理
- 文本添加
- 图片格式转换
- 多种模式图片生成逻辑
- 知识图片生成

#### 1.3 src/services/dbService.js
- IndexedDB数据存储
- 文件夹编号管理
- Excel文件缓存

#### 1.4 src/components/
- FileUploader.js：文件上传组件，支持拖拽功能
- ProgressBar.js：进度显示组件
- ProcessingControl.js：处理控制组件
- ProcessingStatus.js：处理状态显示组件

### 2. 主要函数说明
#### 2.1 图片处理函数
- processImages()：主处理流程，处理所有模式的图片生成
- generateContentPages()：宽松模式生成内页
- generateContentPagesStrict()：严谨模式生成内页
- generateContentPagesCautious()：谨慎模式生成内页
- generateKnowledgeImage()：生成知识图片
- parseKnowledgeExcel()：解析知识Excel文件
- drawRoundedRect()：绘制圆角矩形（用于知识图片）

#### 2.2 数据处理函数
- parseExcel()：解析Excel文件
- shuffleArray()：数组随机打乱
- wrapText()：文本自动换行处理
- canvasToBlob()：画布转换为二进制数据
- calculateTextHeight()：计算文本高度（用于谨慎模式）

## 更新日志

### 2024.04.05
- 更新：知识图片重命名，现在与内页图片序号连续
- 优化：文件组织结构更加一致，所有内容图片使用统一的命名规则

### 2024.04.01
- 新增：知识拼接模式，支持从Excel生成精美知识图片
- 新增：内页数量限制功能，可设置每份文件夹内页数量
- 新增：谨慎模式，只在第一页显示标题
- 优化：文本行间距和底部边距处理
- 优化：文件上传交互体验
- 优化：增大内页文字最大行数
- 修复：多个UI和交互细节问题

### 2024.03.26
- 新增：图片格式选择功能（JPG/PNG）
- 优化：移除预估素材数量逻辑
- 优化：简化错误提示信息
- 新增：严谨模式和宽松模式
- 部署：更新部署端口为3326

### 2024.03.25
- 新增：支持无封面图片模式
- 优化：下载成功提示的显示逻辑
- 优化：文件处理性能提升

## 谨慎模式详细说明
谨慎模式是严谨模式的升级版本，主要有以下特点：

1. **标题处理**：只在第一页显示标题，其他页面不显示
2. **空间利用**：非第一页由于没有标题，有更多可用空间
3. **底部边距**：页面底部保留10像素的边距，最大化利用空间
4. **顶部边距**：非第一页保持160像素的顶部边距，保证视觉美观
5. **实现方式**：通过`generateContentPagesCautious`函数实现，函数使用`isFirstPage`变量跟踪是否为第一页
6. **分页逻辑**：使用`calculateTextHeight`函数动态计算文本高度，避免文字被截断

## 知识拼接模式详细说明
知识拼接模式是一种创新的图片生成模式，可以与其他内页模式并存：

1. **数据源**：使用单独上传的知识Excel文件，需包含A列(标题)和B列(内容)
2. **生成数量**：可设置每份文件夹生成的知识图片数量(0-50)
3. **使用规则**：每个标题内容对只使用一次，不重复使用
4. **命名规则**：知识图片的命名与内页图片保持连续性，例如已有内页1-3，则知识图片会命名为内页4、内页5等
5. **设计风格**：
   - 灰色背景(#f0f2f5)
   - 白色圆角卡片(20px圆角)
   - 卡片阴影效果
   - 四角装饰元素
   - 居中加粗标题
   - 蓝色分隔线
   - 左对齐正文
6. **文本处理**：
   - 标题自动换行
   - 内容保留原始换行格式
   - 段落间距自动调整
7. **实现函数**：
   - parseKnowledgeExcel：解析知识Excel
   - generateKnowledgeImage：生成知识图片
   - drawRoundedRect：绘制圆角矩形

## 部署指南

### 1. 环境要求
- Node.js 16+
- Nginx 1.18+
- 服务器内存 >= 2GB
- 磁盘空间 >= 10GB

### 2. 构建步骤
```bash
# 安装依赖
npm install

# 构建生产版本
npm run build
```

### 3. 服务器部署
```bash
# 创建部署目录
mkdir -p /var/www/IMAGE0326

# 上传构建文件
scp -r dist/* root@服务器IP:/var/www/IMAGE0326/

# 配置Nginx
# 在/etc/nginx/conf.d/创建配置文件
server {
    listen 3326;
    server_name localhost;
    root /var/www/IMAGE0326;
    index index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# 开放防火墙端口
ufw allow 3326/tcp
ufw reload

# 重启Nginx
systemctl restart nginx
```

### 4. 访问地址
- http://服务器IP:3326

### 5. 注意事项
- 确保服务器防火墙开放3326端口
- 检查阿里云安全组配置
- 确保Nginx配置文件语法正确
- 定期检查日志文件
- 建议配置SSL证书

## 问题排查

### 1. 常见问题
- 图片上传失败：检查文件大小和格式
- 处理超时：检查服务器内存使用
- 下载失败：检查网络连接和文件大小
- 页面无响应：检查浏览器控制台错误
- 知识条目不足：确保知识Excel文件包含足够的条目
- 内页标题不显示：检查是否使用谨慎模式

### 2. 性能优化建议
- 图片大小建议不超过5MB
- Excel文件行数建议不超过1000行
- 知识Excel文件建议不超过500条
- 建议使用Chrome或Firefox浏览器
- 定期清理浏览器缓存
- 大批量处理时考虑使用宽松模式

## 联系与支持
如有问题请联系技术支持
